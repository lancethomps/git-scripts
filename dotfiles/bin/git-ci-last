#!/usr/bin/env bash
################################################################### SETUP ########################################################################
if ! _SCRIPT_DIR="$(get_script_dir "${BASH_SOURCE[0]}")"; then echo "Error while running: _SCRIPT_DIR=\"\$(get_script_dir \"${BASH_SOURCE[0]}\")\"" && exit 1; fi
# shellcheck source=./.git_command_defaults.sh
source "${_SCRIPT_DIR}/.git_command_defaults.sh" || exit 1
##################################################################################################################################################

check_supported_ci_types "${CI_JENKINS}"

# shellcheck source=.dotfiles/.jenkins_script_setup.sh disable=SC1091
source "$DOTFILES/.jenkins_script_setup.sh"

job_url="$(get_job_url_from_repo)"

api_url="${job_url}/lastBuild/api/json"
api_response="$(curl --user "$(get_jenkins_basic_auth)" --silent "$api_url")"

if ! echo "$api_response" | jq --sort-keys --exit-status; then
  echo "ERROR Problem with Jenkins response from ${api_url} - output below" >&2
  echo "$api_response" >&2
  exit 1
fi

exit 0
