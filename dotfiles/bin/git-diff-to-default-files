#!/usr/bin/env bash
################################################################### SETUP ########################################################################
if ! _SCRIPT_DIR="$(get_script_dir "${BASH_SOURCE[0]}")"; then echo "Error while running: _SCRIPT_DIR=\"\$(get_script_dir \"${BASH_SOURCE[0]}\")\"" && exit 1; fi
# shellcheck source=bin/.git_command_defaults.sh disable=SC2016
if test -e "${_SCRIPT_DIR}/.git_command_defaults.sh"; then source "${_SCRIPT_DIR}/.git_command_defaults.sh"; else echo '"${_SCRIPT_DIR}/.git_command_defaults.sh" does not exist - resolved to: '"${_SCRIPT_DIR}/.git_command_defaults.sh" && exit 1; fi
##################################################################################################################################################

GIT_CURRENT_BRANCH="$(git current-branch)"
_FZF_ARGS=(
  --ansi
  --no-sort
  --layout "reverse"
  --multi
  --header "use right arrow to open in idea | current branch: ${GIT_CURRENT_BRANCH}"
  --bind 'right:execute-silent(open_grepped_lines --no-line-numbers {})'
)

if command -v ask_to_open_grepped_lines >/dev/null 2>&1; then
  results="$(git diff-to-default --name-only "$@" | fzf "${_FZF_ARGS[@]}")"
  results_exit_code="$?"
  ask_to_open_grepped_lines --lines-exit-code "$results_exit_code" "$results"
else
  git diff-to-default --name-only "$@" | fzf "${_FZF_ARGS[@]}"
fi
