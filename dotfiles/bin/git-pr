#!/usr/bin/env bash
################################################################### SETUP ########################################################################
if ! _SCRIPT_DIR="$(get_script_dir "${BASH_SOURCE[0]}")"; then echo "Error while running: _SCRIPT_DIR=\"\$(get_script_dir \"${BASH_SOURCE[0]}\")\"" && exit 1; fi
# shellcheck source=bin/.git_command_defaults.sh disable=SC2016
if test -e "${_SCRIPT_DIR}/.git_command_defaults.sh"; then source "${_SCRIPT_DIR}/.git_command_defaults.sh"; else echo '"${_SCRIPT_DIR}/.git_command_defaults.sh" does not exist - resolved to: '"${_SCRIPT_DIR}/.git_command_defaults.sh" && exit 1; fi
##################################################################################################################################################

git_url="$(git url)"
scm_domain="$(echo "$git_url" | pcregrep -o3 "$GIT_URL_REGEX")"
git_current_branch="$(git current-branch)"
git_current_branch_url="$(urlencode_git_current_branch "$git_current_branch")"

function github_url() {
  echo "${browse_url_root}/pull/new/${git_current_branch_url}"
}

function bitbucket_url() {
  echo "${browse_url_root}/compare/commits?sourceBranch=refs/heads/${git_current_branch_url}"
}

browse_url_root="$(git ui-url-root)"
if test "$scm_domain" = 'github.com'; then
  pr_url="$(github_url)"
else
  pr_url="$(bitbucket_url)"
fi

if check_debug; then
  echo "$pr_url"
else
  open "$pr_url"
fi
